# Pytest JUnit Assertion Annotate Action

A GitHub Action that parses a **JUnit XML test report** generated by [pytest](https://docs.pytest.org/en/latest/) with the --junit-xml option and publishes **inline annotations** for failed tests in pull requests.

It is tuned for **pytest output** and designed to highlight the actual assertion failure location (line of the failing assert) rather than just the test method definition.

---

## ‚ú® Features

- Extracts real fail position from `E       AssertionError...` in traceback.
- Captures multi-line assertion output so diffs and long comparisons are visible.
- Preserves indentation in failure messages using non‚Äëbreaking spaces, so output in annotations matches original pytest formatting.
- Emits native **GitHub inline annotations** via @actions/core `core.error()` so they appear in the PR "Files Changed" view.
- Compatible with **JUnit XML from pytest**, especially xunit1 family (which includes file and line attributes).
- Includes debug logging controlled by `ACTIONS_STEP_DEBUG` for deeper troubleshooting.

---

## üì¶ Inputs

| Name   | Required | Description                                                |
| ------ | -------- | ---------------------------------------------------------- |
| `file` | ‚úÖ Yes   | Path to the JUnit XML report file (relative to repo root). |

---

## üöÄ Usage

Add a step after running your test suite to invoke the action:

```yaml
name: Test and Annotate

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pytest

      - name: Run tests with JUnit XML output
        run: pytest --junit-xml=report.xml

      - name: Annotate PR with test failures
        if: always()
        uses: your-org/junit-annotate-action@v1
        with:
          file: report.xml
```

---

## üîç How it Works

1. Parses the JUnit XML file.
2. Iterates through `<testcase>` entries.
3. For each `<failure>`:
   - Looks for the last `file.py:line:` entry in the traceback that matches a repo file.
   - Overrides file and line from `<testcase>` attributes with actual failure location.
   - Finds `E       AssertionError` block and collects contiguous `E ‚Ä¶` lines.
   - Preserves indentation with NBSP (`\u00A0`) so spaces are visible in HTML rendered annotations.
4. Calls `core.error()` with:
   - title showing which test failed (`classname:name`).
   - The formatted assertion block as the annotation message.
   - Repo-relative file and line number.

Annotations appear in:

- The PR "Files Changed" tab for failures in changed files.
- The Actions workflow summary for all failures.

---

## üêû Debugging

Enable step debug logging to see detailed extraction:

```yaml
env:
  ACTIONS_STEP_DEBUG: true
```

You‚Äôll then see:

- Failure traceback lines (`(1)` and `(2)` debug output).
- The file and line chosen for annotation.
- The raw extracted message.

---

## ‚ö† Limitations

- Designed for pytest output; may need adjustments for other python test frameworks.
- Works best with `junit_family = xunit1` in `pytest.ini` (to include `<testcase file="..." line="...">` attributes). Falls back to guessing from `classname` + stack trace for `xunit2`.
- Does not currently filter annotations to only changed files (all failures in report file will be annotated).
- Indentation preservation uses NBSP characters, which appear as spaces in raw logs but render correctly in GitHub UI.
- Does not handle multiple assertions failures reported for one test case.

---

## üìÑ License

Cisco proprietary
